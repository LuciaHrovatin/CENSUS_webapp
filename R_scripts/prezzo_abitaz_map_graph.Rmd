# Prezzo medio di vendita delle case

## Import libraries
```{r}

library(dplyr)
library(geojsonio)
library(broom)
library(ggplot2)
library(cowplot)

```
## Import dataset and subset
```{r}
df = read.csv("/Users/elypa/qualita_vita.csv")

df_inter = df[df$INDICATORE == "Prezzo medio di vendita delle case",]
```

## Retrieve NUTS2 code from NUTS3 (deleting the last character)

```{r}
df_inter$REGION = gsub('.{1}$', '', df_inter$CODICE.NUTS.3.2021)
```

## Substitute NUTS2 cose with region name
```{r}
df_inter[df_inter$REGION == "ITC1",]$REGION <- "Piemonte"
df_inter[df_inter$REGION == "ITC2",]$REGION <- "Valle d'Aosta/Vallée d'Aoste"
df_inter[df_inter$REGION == "ITC3",]$REGION <- "Liguria"
df_inter[df_inter$REGION == "ITC4",]$REGION <- "Lombardia"
df_inter[df_inter$REGION == "ITH1",]$REGION <- "Trentino-Alto Adige/Südtirol"
df_inter[df_inter$REGION == "ITH2",]$REGION <- "Trentino-Alto Adige/Südtirol"
df_inter[df_inter$REGION == "ITH3",]$REGION <- "Veneto"
df_inter[df_inter$REGION == "ITH4",]$REGION <- "Friuli-Venezia Giulia"
df_inter[df_inter$REGION == "ITH5",]$REGION <- "Emilia-Romagna"
df_inter[df_inter$REGION == "ITI1",]$REGION <- "Toscana"
df_inter[df_inter$REGION == "ITI2",]$REGION <- "Umbria"
df_inter[df_inter$REGION == "ITI3",]$REGION <- "Marche"
df_inter[df_inter$REGION == "ITI4",]$REGION <- "Lazio"
df_inter[df_inter$REGION == "ITF1",]$REGION <- "Abruzzo"
df_inter[df_inter$REGION == "ITF2",]$REGION <- "Molise"
df_inter[df_inter$REGION == "ITF3",]$REGION <- "Campania"
df_inter[df_inter$REGION == "ITF4",]$REGION <- "Puglia"
df_inter[df_inter$REGION == "ITF5",]$REGION <- "Basilicata"
df_inter[df_inter$REGION == "ITF6",]$REGION <- "Calabria"
df_inter[df_inter$REGION == "ITG1",]$REGION <- "Sicilia"
df_inter[df_inter$REGION == "ITG2",]$REGION <- "Sardegna"

```

## Calculate the mean of value for each region
```{r}
means <- aggregate(VALORE ~ REGION, data = df_inter, FUN = mean)

```

## Add column with the means to the dataset
```{r}

df_inter = df_inter %>%
  right_join(. , means, by=c("REGION"="REGION"))

```

## Import geojson for choropleth map graph
```{r}
spdf = geojson_read("/Users/elypa/limits_IT_regions.geojson",  what = "sp")
spdf_fortified = tidy(spdf, region = "reg_name")
```

## Join the geojson with the dataset
```{r}
spdf_fortified = spdf_fortified %>%
  left_join(. , df_inter, by=c("id"="REGION"))
```

## Plot the choropleth map graph
```{r}

# Plot the result
choropleth_ita_tot_GDP = ggplot() +
  
  # pass info on the map
  geom_polygon(data = spdf_fortified, aes(fill = `VALORE.y`, x = long, y = lat, group = group), color="black") +
  
  # customize theme and title
  labs(title="Prezzo medio di vendita delle case", 
       subtitle="Per appartamenti nuovi di 100 mq in zona semicentrale nei capoluoghi") +
  theme_void() +
  theme(
    plot.title = element_text(size= 30, hjust=0.5, color = "black", margin = margin(b = -0.1, t = 0.4, l = 2, unit = "cm"), face = "italic"),
    plot.subtitle = element_text(size= 17, hjust=0.5, color = "black", margin = margin(b = -0.1, t = 0.43, l = 2, unit = "cm"), face = "italic"),
    plot.background = element_rect(fill = "#fafafa", color = NA),
    plot.margin = unit(c(0, 1, 0, 1), "cm")
    ) +
  guides(fill=guide_legend("EUR")) +
  coord_map() +
  scale_fill_distiller(guide = FALSE, direction = 1, limits=c(930,2960))

choropleth_ita_tot_GDP

```